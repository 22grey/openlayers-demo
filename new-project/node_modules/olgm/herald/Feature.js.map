{"version":3,"file":"Feature.js","sources":["../../../src/olgm/herald/Feature.js"],"sourcesContent":["/**\n * @module olgm/herald/Feature\n */\nimport Icon from 'ol/style/Icon.js';\nimport {getCenterOf, getStyleOf} from '../util.js';\nimport {assert} from '../asserts.js';\nimport {createFeature, createStyle, createLatLng, createMapIcon,\n  createLabel, createFeatureGeometry} from '../gm.js';\nimport Herald from './Herald.js';\nimport PropertyListener from '../listener/PropertyListener.js';\nimport Listener from '../listener/Listener.js';\n\nclass FeatureHerald extends Herald {\n  /**\n   * The Feature Herald is responsible of synchronizing a single ol3 vector\n   * feature to a gmap feature. Here's what synchronized within the feature:\n   *\n   * - its geometry\n   * - its style\n   *\n   * @param {module:ol/PluggableMap} ol3map openlayers map\n   * @param {google.maps.Map} gmap google maps map\n   * @param {olgmx.herald.FeatureOptions} options options\n   */\n  constructor(ol3map, gmap, options) {\n    super(ol3map, gmap);\n\n    /**\n     * @type {module:ol/Feature}\n     * @private\n     */\n    this.feature_ = options.feature;\n\n    /**\n     * @type {module:olgm/AbstractListener~AbstractListener|null}\n     * @protected\n     */\n    this.featureListener_ = null;\n\n    /**\n     * @type {!google.maps.Data}\n     * @private\n     */\n    this.data_ = options.data;\n\n    /**\n     * @type {number}\n     * @private\n     */\n    this.index_ = options.index;\n\n    /**\n     * @type {module:olgm/gm/MapIcon~Options}\n     * @private\n     */\n    this.mapIconOptions_ = options.mapIconOptions;\n\n    /**\n     * @type {boolean}\n     * @private\n     */\n    this.visible_ = options.visible !== undefined ? options.visible : true;\n\n    /**\n     * @type {google.maps.Data.Feature}\n     * @private\n     */\n    this.gmapFeature_ = null;\n\n    /**\n     * @type {module:olgm/gm/MapLabel}\n     * @private\n     */\n    this.label_ = null;\n\n    /**\n     * The marker object contains a marker to draw on a canvas instead of using\n     * the Google Maps API. If useCanvas_ is set to false, this variable won't\n     * be used.\n     * @type {module:olgm/gm/MapIcon}\n     * @private\n     */\n    this.marker_ = null;\n  }\n\n\n  /**\n   * @inheritDoc\n   */\n  activate() {\n    super.activate();\n\n    // create gmap feature\n    this.gmapFeature_ = createFeature(this.feature_);\n\n    if (this.visible_) {\n      this.data_.add(this.gmapFeature_);\n    }\n\n    this.updateStyle_();\n\n    this.featureListener_ = new Listener(this.feature_.on('change', () => this.handleFeatureChange_()));\n\n    this.listener = new PropertyListener(this.feature_, null, this.feature_.getGeometryName(), (geometry, oldGeometry) => {\n      if (oldGeometry) {\n        this.handleGeometryChange_();\n      }\n      return new Listener(geometry.on('change', () => this.handleGeometryChange_()));\n    });\n  }\n\n\n  /**\n   * @inheritDoc\n   */\n  deactivate() {\n    if (this.featureListener_) {\n      this.featureListener_.unlisten();\n    }\n\n    // remove gmap feature\n    this.data_.remove(this.gmapFeature_);\n    this.gmapFeature_ = null;\n\n    // remove feature\n    if (this.marker_) {\n      this.marker_.setMap(null);\n      this.marker_ = null;\n    }\n\n    // remove label\n    if (this.label_) {\n      this.label_.setMap(null);\n      this.label_ = null;\n    }\n\n    super.deactivate();\n  }\n\n\n  /**\n   * Set visible or invisible, without deleting the feature object\n   * @param {boolean} value true to set visible, false to set invisible\n   */\n  setVisible(value) {\n    if (value && !this.visible_) {\n      this.data_.add(this.gmapFeature_);\n\n      if (this.marker_) {\n        this.marker_.setMap(this.gmap);\n      }\n\n      if (this.label_) {\n        this.label_.setMap(this.gmap);\n      }\n\n      this.visible_ = true;\n    } else if (!value && this.visible_) {\n\n      this.data_.remove(this.gmapFeature_);\n\n      if (this.marker_) {\n        this.marker_.setMap(null);\n      }\n\n      if (this.label_) {\n        this.label_.setMap(null);\n      }\n\n      this.visible_ = false;\n    }\n  }\n\n  /**\n   * @private\n   * @return {module:ol/geom/Geometry} the feature's geometry\n   */\n  getGeometry_() {\n    const geometry = this.feature_.getGeometry();\n    assert(\n      geometry !== undefined, 'Expected feature to have geometry');\n    return /** @type {module:ol/geom/Geometry} */ (geometry);\n  }\n\n\n  /**\n   * @private\n   */\n  handleGeometryChange_() {\n    const geometry = this.getGeometry_();\n    this.gmapFeature_.setGeometry(createFeatureGeometry(geometry));\n\n    let latLng;\n\n    if (this.label_) {\n      latLng = createLatLng(getCenterOf(geometry));\n      this.label_.set('position', latLng);\n    }\n\n    if (this.marker_) {\n      latLng = createLatLng(getCenterOf(geometry));\n      this.marker_.set('position', latLng);\n    }\n  }\n\n  /**\n   * @private\n   */\n  handleFeatureChange_() {\n    this.updateStyle_();\n  }\n\n  /**\n   * @private\n   */\n  updateStyle_() {\n\n    // override style if a style is defined at the feature level\n    const mapIconOptions = {useCanvas: this.feature_.useCanvas || this.mapIconOptions_.useCanvas};\n\n    const gmStyle = createStyle(\n      this.feature_, mapIconOptions, this.index_);\n\n    this.data_.overrideStyle(this.gmapFeature_, gmStyle);\n\n    const prevMarker = this.marker_;\n    const prevLabel = this.label_;\n\n    const style = getStyleOf(this.feature_);\n    if (style) {\n      const latLng = createLatLng(getCenterOf(this.getGeometry_()));\n\n      const zIndex = style.getZIndex();\n      const index = zIndex !== undefined ? zIndex : this.index_;\n\n      const image = style.getImage();\n      if (image && image instanceof Icon && mapIconOptions.useCanvas) {\n        this.marker_ = createMapIcon(image, latLng, index, this.feature_.get('olgm_pane'));\n        if (this.visible_) {\n          this.marker_.setMap(this.gmap);\n        }\n      }\n\n      const text = style.getText();\n      if (text) {\n        this.label_ = createLabel(text, latLng, index, this.feature_.get('olgm_pane'));\n        if (this.visible_) {\n          this.label_.setMap(this.gmap);\n        }\n      }\n    }\n\n    if (prevMarker) {\n      prevMarker.setMap(null);\n    }\n    if (prevLabel) {\n      prevLabel.setMap(null);\n    }\n  }\n}\nexport default FeatureHerald;\n"],"names":["super","this","const","let"],"mappings":"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"}